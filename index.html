<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLEセンサメータ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 20px;
            background-color: #000;
            color: #ff0000;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 95vh;
            justify-content: flex-start;
        }
        button {
            background-color: #ff0000;
            color: #000;
            border: none;
            padding: 10px 20px;
            font-size: 1.2em;
            cursor: pointer;
            border-radius: 5px;
            margin-top: 30px;
            margin-bottom: 20px;
        }

        .digital-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
            width: 100%;
            max-width: 230px;
            min-width: 200px;
            margin-top: 30px;
        }
        .digital-display, .external-pressure-display {
            background-color: #333;
            border: 3px solid #ff0000;
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            width: 200px;
            text-align: center;
        }
        .digital-label, .external-label {
            font-size: 1.3em;
            font-weight: bold;
            color: #ff0000;
            margin-bottom: 5px;
        }
        .digital-value, .external-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #ff0000;
        }
        .external-value {
             font-size: 2.2em;
        }

        .meter {
            width: 100%;
            max-width: 250px;
            aspect-ratio: 1 / 1;
            min-width: 180px;
            flex-shrink: 0;
            position: relative;
            border: 5px solid #ff0000;
            border-radius: 50%;
            background: #333;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            margin-top: 20px;
        }
        .meter-center {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 12px;
            height: 12px;
            background-color: #ff0000;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
        }
        .meter-needle {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 110px;
            background-color: #ff0000;
            transform-origin: bottom center;
            transform: translateX(-50%) translateY(-100%) rotate(180deg);
            transition: transform 0.2s ease-out;
            z-index: 1;
        }
        .meter-number {
            position: absolute;
            top: 50%;
            left: 50%;
            font-size: 1.2em;
            color: #ff0000;
            font-weight: bold;
            z-index: 3;
        }

        /* グラフのスタイル */
        .chart-container {
            width: 100%;
            max-width: 600px; /* グラフの最大幅を調整 */
            height: 300px; /* グラフの高さ */
            margin-top: 30px;
            background-color: #333;
            border: 3px solid #ff0000;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            box-sizing: border-box; /* paddingとborderをwidthに含める */
        }
        .chart-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #ff0000;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="meter">
        <div class="meter-needle" id="pressNeedle"></div>
        <div class="meter-center"></div>
        <script>
            // JavaScriptでメーターの数値を動的に配置
            const NUMBER_RADIUS = 105.0;
            const MARKER_START_DEGREE = 180.0;
            const MARKER_END_DEGREE = 450.0;
            const MARKER_TOTAL_RANGE_DEGREE = MARKER_END_DEGREE - MARKER_START_DEGREE;
            const MARKER_OFFSET_DEGREE = -90.0;

            for (let i = 0; i <= 1000; i += 100) {
                let current_value = parseFloat(i);
                let base_degree = MARKER_START_DEGREE + (current_value / 1000.0) * MARKER_TOTAL_RANGE_DEGREE;
                let final_degree = base_degree + MARKER_OFFSET_DEGREE;

                document.write(`<div class='meter-number' style='transform: rotate(${final_degree}deg) translate(${NUMBER_RADIUS}px) rotate(-${final_degree}deg) translate(-50%, -50%);'>${i}</div>`);
            }
        </script>
    </div>

    <div class="digital-panel">
        <div class="external-pressure-display">
            <div class="external-label">油圧 (kPa)</div>
            <div class="external-value" id="pressValue">--.--</div>
        </div>
        <div class="digital-display">
            <div class="digital-label">油温 (&deg;C)</div>
            <div class="digital-value" id="tempValue">--.--</div>
        </div>
    </div>

    <button id="connectButton">BLEデバイスに接続</button>

    <div class="chart-container">
        <div class="chart-title">油温・油圧 過去20秒</div>
        <canvas id="sensorChart"></canvas>
    </div>

    <script>
        // Arduinoスケッチで設定したUUIDをここに記述
        // 必ずご自身のUUIDに置き換えてください！
        const SERVICE_UUID = '93c51ed2-cfe3-409c-a0f2-c41b2bb9fca3';
        const TEMPERATURE_CHARACTERISTIC_UUID = 'bb3626f1-393f-486d-9a94-0700ee1c88ac';
        const PRESSURE_CHARACTERISTIC_UUID = 'c72e0888-651b-4a83-8b69-4b124ee8ad21';

        let sensorDevice;
        let temperatureChar;
        let pressureChar;

        const MIN_DEGREE = 180.0;
        const MAX_DEGREE = 450.0;
        const TOTAL_DEGREE_RANGE = MAX_DEGREE - MIN_DEGREE;
        const PRESS_MIN_VALUE = 0.0;
        const PRESS_MAX_VALUE = 1000.0;

        // グラフ関連の変数
        const CHART_DURATION_SECONDS = 20; // グラフの表示期間（秒）
        const REMOVE_OLD_DATA_INTERVAL_MS = 1000; // 古いデータをチェックし削除する間隔（ミリ秒）
        
        let temperatureData = []; // データ形式: { x: timestamp(ms), y: value }
        let pressureData = [];    // データ形式: { x: timestamp(ms), y: value }
        let sensorChart; // Chart.jsインスタンス
        
        // Chart.jsの初期化
        document.addEventListener('DOMContentLoaded', () => {
            const ctx = document.getElementById('sensorChart').getContext('2d');
            sensorChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: '油温 (°C)',
                            data: temperatureData,
                            borderColor: '#00ccff', // 油温のグラフの色 (青系)
                            backgroundColor: 'rgba(0, 204, 255, 0.2)',
                            tension: 0.1, // 線の滑らかさ
                            fill: false, // 塗りつぶしなし
                            yAxisID: 'yTemp', // Y軸ID
                            parsing: false // x,yプロパティを直接使うためパースを無効化
                        },
                        {
                            label: '油圧 (kPa)',
                            data: pressureData,
                            borderColor: '#ffcc00', // 油圧のグラフの色 (黄系)
                            backgroundColor: 'rgba(255, 204, 0, 0.2)',
                            tension: 0.1,
                            fill: false,
                            yAxisID: 'yPress', // Y軸ID
                            parsing: false // x,yプロパティを直接使うためパースを無効化
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // アスペクト比を固定しない
                    animation: {
                        duration: 0 // アニメーションを無効化してスムーズなスクロールを実現
                    },
                    scales: {
                        x: {
                            type: 'time', // ★変更点★ 時間軸に設定
                            time: {
                                unit: 'second', // 秒単位
                                displayFormats: {
                                    second: 'mm:ss' // 例: 00:00, 00:01
                                },
                                tooltipFormat: 'yyyy/MM/dd HH:mm:ss' // ツールチップの表示形式
                            },
                            title: {
                                display: true,
                                text: '時間',
                                color: '#ff0000'
                            },
                            ticks: {
                                color: '#ff0000',
                                callback: function(value, index, ticks) {
                                    // ★変更点★ X軸の表示を-20sから0sに固定
                                    // 最新のタイムスタンプとの差を計算して表示
                                    if (temperatureData.length === 0 && pressureData.length === 0) return '';
                                    const now = new Date().getTime();
                                    const diffSeconds = Math.round((value - now) / 1000);
                                    // 0s は現在時刻、-1s は1秒前
                                    return diffSeconds + 's';
                                }
                            },
                            grid: {
                                color: 'rgba(255, 0, 0, 0.2)'
                            },
                            // minとmaxはupdateChartで動的に設定するためここでは指定しない
                        },
                        yTemp: { // 油温用のY軸
                            position: 'left', // 左側に表示
                            title: {
                                display: true,
                                text: '油温 (°C)',
                                color: '#00ccff'
                            },
                            ticks: {
                                color: '#00ccff'
                            },
                            grid: {
                                color: 'rgba(255, 0, 0, 0.2)'
                            },
                            min: 0, // 油温の最小値 (適宜調整してください)
                            max: 120 // 油温の最大値 (適宜調整してください)
                        },
                        yPress: { // 油圧用のY軸
                            position: 'right', // 右側に表示
                            title: {
                                display: true,
                                text: '油圧 (kPa)',
                                color: '#ffcc00'
                            },
                            ticks: {
                                color: '#ffcc00'
                            },
                            grid: {
                                color: 'rgba(255, 0, 0, 0.2)'
                            },
                            min: 0, // 油圧の最小値 (適宜調整してください)
                            max: 1000 // 油圧の最大値 (適宜調整してください)
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ff0000' // 凡例の文字色
                            }
                        }
                    }
                }
            });
            document.getElementById('connectButton').onclick = connectDevice;
        });


        document.getElementById('connectButton').addEventListener('click', async () => {
            try {
                sensorDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [SERVICE_UUID] }]
                });

                console.log('選択されたデバイス:', sensorDevice.name);

                sensorDevice.addEventListener('gattserverdisconnected', onDisconnected);

                const server = await sensorDevice.gatt.connect();
                console.log('GATTサーバーに接続しました。');

                const service = await server.getPrimaryService(SERVICE_UUID);
                temperatureChar = await service.getCharacteristic(TEMPERATURE_CHARACTERISTIC_UUID);
                pressureChar = await service.getCharacteristic(PRESSURE_CHARACTERISTIC_UUID);
                console.log('キャラクタリスティックを取得しました。');

                temperatureChar.addEventListener('characteristicvaluechanged', handleTemperatureNotifications);
                await temperatureChar.startNotifications();
                console.log('温度の通知を開始しました。');

                pressureChar.addEventListener('characteristicvaluechanged', handlePressureNotifications);
                await pressureChar.startNotifications();
                console.log('油圧の通知を開始しました。');

                document.getElementById('connectButton').textContent = '接続済み (切断)';
                document.getElementById('connectButton').onclick = disconnectDevice;

            } catch (error) {
                console.error('BLE接続エラー:', error);
                alert('BLEデバイスへの接続に失敗しました。詳細をコンソールで確認してください。');
                document.getElementById('connectButton').textContent = 'BLEデバイスに接続';
                document.getElementById('connectButton').onclick = connectDevice;
            }
        });

        function onDisconnected(event) {
            const device = event.target;
            console.log(`デバイス "${device.name}" が切断されました。`);
            document.getElementById('tempValue').textContent = '--.--';
            document.getElementById('pressValue').textContent = '--.--';
            document.getElementById('pressNeedle').style.transform = 'translateX(-50%) translateY(-100%) rotate(180deg)';
            document.getElementById('connectButton').textContent = 'BLEデバイスに接続';
            document.getElementById('connectButton').onclick = connectDevice;

            // グラフデータをリセット
            temperatureData = [];
            pressureData = [];
            sensorChart.update();
        }

        function handleTemperatureNotifications(event) {
            const value = event.target.value;
            const temperature = value.getFloat32(0, true);
            document.getElementById('tempValue').textContent = temperature.toFixed(2);
            // 現在のタイムスタンプを取得
            const now = new Date().getTime();
            updateChartData(now, temperature, pressureData.length > 0 ? pressureData[pressureData.length - 1].y : NaN);
        }

        function handlePressureNotifications(event) {
            const value = event.target.value;
            const pressure = value.getFloat32(0, true);
            updateMeter(pressure, PRESS_MIN_VALUE, PRESS_MAX_VALUE, 'pressNeedle', 'pressValue');
            // 現在のタイムスタンプを取得
            const now = new Date().getTime();
            updateChartData(now, temperatureData.length > 0 ? temperatureData[temperatureData.length - 1].y : NaN, pressure);
        }

        function updateMeter(value, minValue, maxValue, needleId, valueId) {
            let normalizedValue = (value - minValue) / (maxValue - minValue);
            if (normalizedValue < 0) normalizedValue = 0;
            if (normalizedValue > 1) normalizedValue = 1;

            let rotation = MIN_DEGREE + normalizedValue * TOTAL_DEGREE_RANGE;
            document.getElementById(needleId).style.transform = 'translateX(-50%) translateY(-100%) rotate(' + rotation + 'deg)';
            document.getElementById(valueId).textContent = value.toFixed(2);
        }

        // グラフデータ更新関数
        function updateChartData(timestamp, temp, press) {
            // 新しいデータを追加
            // NaN (Not a Number) はプロットされないので、初期値やデータがない場合はNaNを渡す
            if (!isNaN(temp)) {
                temperatureData.push({ x: timestamp, y: temp });
            }
            if (!isNaN(press)) {
                pressureData.push({ x: timestamp, y: press });
            }

            // 古いデータを削除
            const cutoffTime = timestamp - (CHART_DURATION_SECONDS * 1000); // 20秒前のタイムスタンプ
            
            // 古いデータを削除
            while (temperatureData.length > 0 && temperatureData[0].x < cutoffTime) {
                temperatureData.shift();
            }
            while (pressureData.length > 0 && pressureData[0].x < cutoffTime) {
                pressureData.shift();
            }

            // X軸の表示範囲を更新
            sensorChart.options.scales.x.min = cutoffTime;
            sensorChart.options.scales.x.max = timestamp;

            // グラフを更新
            sensorChart.update();
        }

        function disconnectDevice() {
            if (sensorDevice && sensorDevice.gatt.connected) {
                sensorDevice.gatt.disconnect();
                console.log('デバイスを切断しました。');
            } else {
                console.log('接続中のデバイスはありません。');
            }
        }

        function connectDevice() {
             document.getElementById('connectButton').click();
        }
    </script>
</body>
</html>